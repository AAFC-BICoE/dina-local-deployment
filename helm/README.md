## Pre-requisites

1. Helm
2. Minikube
3. Local certificates

## Installing Minikube and Helm

 * Minikube [instructions](https://aafc-bicoe.github.io/dina-local-deployment/#_minikube)
 * Helm [instructions](https://aafc-bicoe.github.io/dina-local-deployment/#_helm)

## Deploying application

### Local certificates

Local certificates are required to run the application locally without having warnings from the browser.

If you already have the certificates from the docker-compose based local deployment, you can copy them.
Otherwise, see [instructions](https://aafc-bicoe.github.io/dina-local-deployment/#_local_certificates) and make sure to install them in `helm/config/certs`.

### hosts file

Edit etc/hosts file map ingress ip to addresses used:

Get ingress ip:

```
minikube kubectl -- get nodes -o wide
```

Sample output:
```
NAME       STATUS   ROLES           AGE     VERSION   INTERNAL-IP    EXTERNAL-IP   OS-IMAGE             KERNEL-VERSION     CONTAINER-RUNTIME
minikube   Ready    control-plane   4d18h   v1.27.4   192.168.49.2   <none>        Ubuntu 22.04.2 LTS   6.2.0-36-generic   docker://24.0.4
```
Ingress IP is listed under 'INTERNAL-IP'

In `/etc/hosts` file, add the following lines:
 
```
<INGRESS IP> dina.local
<INGRESS IP> keycloak.dina.local
```

### Passwords

Unless a password is explicitly provided in `values.yaml`, the chart will automaticly generate them and store them in a secret for future run. The default behavior is auto-generating the secrets and the passwords in global.environment.config block are left empty for that purpose. Should the user prefer to provide static passwords, that is where they should do it.

To get an auto-generated password (e.g. login in Keycloak admin console) : `kubectl get secrets keycloak-admin-secret -o json | jq .data.password | tr -d '"' | base64 -d` or `kubectl get secret keycloak-admin-secret -o jsonpath="{.data.password}" | base64 --decode`

### Deploy chart

From dina-local-deployment root:

`helm install dina-helm ./helm -f helm/values.yaml`

To remove the chart: `helm uninstall dina-helm`


### Deploying chart in OKD environment or alternative environments.

From dina-local-deployment root

`helm install dina-helm ./helm -f helm/values.yaml -f helm/<additional_value_injection.yaml>`

In Helm, when multiple injection values are passed as arguments, such as in this example, the rightmost file takes precedence in overriding previously injected values.

Note that if you require additional alternative override values it is always preferrable to define it in a new injection file.

### Helm Deployment particularities

* DINA modules all have their own init-container to initialize the database
* Passwords are auto-generated by Helm unless they are explicitly provided in `values.yaml`

